/**
 * –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω –Ω–∞ –ê–≤–∏—Ç–æ.
 * –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:
 * 1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ –ê–≤–∏—Ç–æ (–≥–¥–µ –µ—Å—Ç—å –ø–æ–ª—è "–¶–µ–Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞").
 * 2. –ù–∞–∂–º–∏—Ç–µ F12, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É Console.
 * 3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å —ç—Ç–æ—Ç –∫–æ–¥ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª—å.
 * 4. –ù–∞–∂–º–∏—Ç–µ Enter.
 */

(async function automateAvitoPrices() {
    console.log("üöÄ –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ü–µ–Ω...");

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—É–∑—ã
    const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–Ω–∞—á–µ–Ω–∏—è –≤ React-input (React –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–µ—Ç—Ç–µ—Ä—ã)
    const setNativeValue = (element, value) => {
        const valueSetter = Object.getOwnPropertyDescriptor(element, 'value').set;
        const prototype = Object.getPrototypeOf(element);
        const prototypeValueSetter = Object.getOwnPropertyDescriptor(prototype, 'value').set;
        
        if (valueSetter && valueSetter !== prototypeValueSetter) {
            prototypeValueSetter.call(element, value);
        } else {
            valueSetter.call(element, value);
        }
        
        element.dispatchEvent(new Event('input', { bubbles: true }));
        element.dispatchEvent(new Event('change', { bubbles: true }));
        element.dispatchEvent(new Event('blur', { bubbles: true }));
    };

    // 1. –ü–æ–∏—Å–∫ –≤—Å–µ—Ö –Ω–∞–¥–ø–∏—Å–µ–π "–¶–µ–Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞"
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º XPath, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Ç–µ–∫—Å—Ç, –∞ –∑–∞—Ç–µ–º –Ω–∞–π—Ç–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–π input
    const xpath = "//div[contains(text(), '–¶–µ–Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞')]";
    const result = document.evaluate(xpath, document, null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);

    const inputsToProcess = [];

    for (let i = 0; i < result.snapshotLength; i++) {
        const labelNode = result.snapshotItem(i);
        // –ò—â–µ–º input —Ä—è–¥–æ–º —Å label. –û–±—ã—á–Ω–æ –æ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º –∏–ª–∏ —Å–æ—Å–µ–¥–Ω–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.
        // –ü–æ–π–¥–µ–º –≤–≤–µ—Ä—Ö –∫ –æ–±—â–µ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –∏ –Ω–∞–π–¥–µ–º —Ç–∞–º input.
        // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ê–≤–∏—Ç–æ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è, –Ω–æ –æ–±—ã—á–Ω–æ input –Ω–µ–¥–∞–ª–µ–∫–æ.
        // –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ input –≤ —Å–ª–µ–¥—É—é—â–µ–º —ç–ª–µ–º–µ–Ω—Ç–µ –∏–ª–∏ –≤–Ω—É—Ç—Ä–∏ —Ä–æ–¥–∏—Ç–µ–ª—è.
        
        // –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –ò—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π input –≤–Ω—É—Ç—Ä–∏ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –±–ª–æ–∫–∞ (–ø–æ–¥–Ω–∏–º–∞–µ–º—Å—è –Ω–∞ –ø–∞—Ä—É —É—Ä–æ–≤–Ω–µ–π –≤–≤–µ—Ä—Ö)
        let container = labelNode.parentElement; 
        let input = container.querySelector('input');
        
        // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Å—Ä–∞–∑—É, –ø–æ–¥–Ω–∏–º–µ–º—Å—è –≤—ã—à–µ (–∏–Ω–æ–≥–¥–∞ label –∏ input —Å–æ—Å–µ–¥–∏ –≤ –æ–±–µ—Ä—Ç–∫–µ)
        if (!input) {
            container = container.parentElement;
            input = container ? container.querySelector('input') : null;
        }

        if (input) {
            inputsToProcess.push({ label: labelNode, input: input });
        }
    }

    console.log(`üîé –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${inputsToProcess.length}`);

    if (inputsToProcess.length === 0) {
        console.warn("‚ö†Ô∏è –ü–æ–ª—è '–¶–µ–Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞' –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –í–æ–∑–º–æ–∂–Ω–æ, –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –≤–µ—Ä—Å—Ç–∫–∞ –∏–ª–∏ –≤—ã –Ω–µ –Ω–∞ —Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.");
        return;
    }

    // 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è
    for (const item of inputsToProcess) {
        const { input } = item;
        
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ —É–∂–µ 0 (—Ö–æ—Ç—è –º—ã —Ö–æ—Ç–∏–º –ø–æ–ª—É—á–∏—Ç—å –æ—à–∏–±–∫—É, —Ç–∞–∫ —á—Ç–æ —Å—Ç–∞–≤–∏–º 0 –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)
        console.log("Processing input...", input);

        // A. –°—Ç–∞–≤–∏–º 0, —á—Ç–æ–±—ã —Å–ø—Ä–æ–≤–æ—Ü–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É –º–∏–Ω–∏–º—É–º–∞
        setNativeValue(input, "0");
        
        // –ñ–¥–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏ (–∞–Ω–∏–º–∞—Ü–∏—è UI –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å –≤—Ä–µ–º—è)
        await delay(1500); 

        // B. –ò—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —Ä—è–¥–æ–º —Å –∏–Ω–ø—É—Ç–æ–º
        // –û—à–∏–±–∫–∞ –æ–±—ã—á–Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç "–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞" –∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ä—è–¥–æ–º
        // –ò—â–µ–º –≤–æ –≤—Å–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —Ä–µ–≥–∏–æ–Ω–∞ (–ø–æ–¥–Ω–∏–º–∞–µ–º—Å—è –≤—ã—à–µ)
        let regionBlock = input.closest('div[class*="style-item-"]'); // –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ –±–ª–æ–∫
        if (!regionBlock) regionBlock = input.parentElement.parentElement.parentElement; // –§–æ–ª–±–µ–∫

        if (!regionBlock) {
             console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–ª–æ–∫–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ—à–∏–±–∫–∏.");
             continue;
        }

        // –ò—â–µ–º —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –≤ —ç—Ç–æ–º –±–ª–æ–∫–µ
        // –ü—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–∞: "–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ ‚Äî 22 ‚ÇΩ" –∏–ª–∏ "–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ ..."
        const errorElement = Array.from(regionBlock.querySelectorAll('*')).find(el => 
            el.textContent.includes("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞") || el.textContent.includes("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞")
        );

        if (errorElement) {
            const errorText = errorElement.textContent;
            console.log(`‚ùó –ù–∞–π–¥–µ–Ω–∞ –æ—à–∏–±–∫–∞: "${errorText}"`);

            // C. –ü–∞—Ä—Å–∏–º —Ü–µ–Ω—É (–∏—â–µ–º —Ü–∏—Ñ—Ä—ã)
            // –†–µ–≥—É–ª—è—Ä–∫–∞ –∏—â–µ—Ç —á–∏—Å–ª–æ –ø–æ—Å–ª–µ —Å–ª–æ–≤ "—Ü–µ–Ω–∞" –∏–ª–∏ "—Å—Ç–∞–≤–∫–∞" –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ –≤ —Å—Ç—Ä–æ–∫–µ
            const match = errorText.match(/(\d+)\s*‚ÇΩ/); // –ò—â–µ–º —á–∏—Å–ª–æ –ø–µ—Ä–µ–¥ –∑–Ω–∞–∫–æ–º —Ä—É–±–ª—è
            const matchSimple = errorText.match(/(\d+)/); // –§–æ–ª–±–µ–∫ –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ, –µ—Å–ª–∏ –∑–Ω–∞–∫–∞ —Ä—É–±–ª—è –Ω–µ—Ç
            
            let minPrice = null;
            if (match) {
                minPrice = match[1];
            } else if (matchSimple) {
                // –ù—É–∂–Ω–æ –±—ã—Ç—å –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–º, —á—Ç–æ–±—ã –Ω–µ –≤–∑—è—Ç—å —Ü–∏—Ñ—Ä—É –∏–∑ –¥—Ä—É–≥–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –Ω–æ –æ–±—ã—á–Ω–æ —Ç–∞–º —Ç–æ–ª—å–∫–æ —Ü–µ–Ω–∞
                minPrice = matchSimple[1];
            }

            if (minPrice) {
                console.log(`‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞: ${minPrice}`);
                
                // D. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ü–µ–Ω—É
                setNativeValue(input, minPrice);
                // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                await delay(500); 
            } else {
                console.warn("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —á–∏—Å–ª–æ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –æ—à–∏–±–∫–∏.");
            }
        } else {
            console.warn("‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏–µ –æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω–µ –Ω–µ –ø–æ—è–≤–∏–ª–æ—Å—å –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ 0.");
        }
    }

    console.log("üèÅ –ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ü–µ–Ω—ã.");
    alert("–ì–æ—Ç–æ–≤–æ! –¶–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–æ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö.");
})();
